<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to mikropml • mikropml</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to mikropml">
<meta property="og:description" content="mikropml">
<meta property="og:image" content="http://www.schlosslab.org/mikropml/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mikropml</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.2.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    <li class="dropdown-header">Paper</li>
    <li>
      <a href="../articles/paper.html">mikropml: User-Friendly R Package for Supervised Machine Learning Pipelines</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Vignettes</li>
    <li>
      <a href="../articles/introduction.html">Introduction to mikropml</a>
    </li>
    <li>
      <a href="../articles/preprocess.html">Preprocessing data</a>
    </li>
    <li>
      <a href="../articles/tuning.html">Hyperparameter tuning</a>
    </li>
    <li>
      <a href="../articles/parallel.html">Parallel processing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/SchlossLab/mikropml/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="introduction_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to mikropml</h1>
                        <h4 class="author">Zena Lapp</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/SchlossLab/mikropml/blob/master/vignettes/introduction.Rmd"><code>vignettes/introduction.Rmd</code></a></small>
      <div class="hidden name"><code>introduction.Rmd</code></div>

    </div>

    
    
<p>The goal of <code>mikropml</code> is to make supervised machine learning (ML) easy for you to run while implementing good practices for machine learning pipelines. All you need to run ML pipeline is one function: <code><a href="../reference/run_ml.html">run_ml()</a></code>. We’ve selected sensible default arguments related to good practices <span class="citation">(Topçuoğlu et al. 2020; Tang et al. 2020)</span>, but we allow you to change those arguments to tailor <code><a href="../reference/run_ml.html">run_ml()</a></code> to the needs of your data.</p>
<p>This document takes you through all of the <code><a href="../reference/run_ml.html">run_ml()</a></code> inputs, both required and optional, as well as the outputs.</p>
<p>In summary, you provide:</p>
<ul>
<li>A dataset with an outcome column and feature columns (rows are samples)</li>
<li>Model choice (i.e. method)</li>
</ul>
<p>And the function outputs:</p>
<ul>
<li>The trained model</li>
<li>Model performance metrics</li>
<li>(Optional) feature importance metrics</li>
</ul>
<div id="its-running-so-slow" class="section level1">
<h1 class="hasAnchor">
<a href="#its-running-so-slow" class="anchor"></a>It’s running so slow!</h1>
<p>Since I assume a lot of you won’t read this entire vignette, I’m going to say this at the beginning. If the <code><a href="../reference/run_ml.html">run_ml()</a></code> function is running super slow, you should consider parallelizing. See <code><a href="../articles/parallel.html">vignette("parallel")</a></code> for examples.</p>
</div>
<div id="understanding-the-inputs" class="section level1">
<h1 class="hasAnchor">
<a href="#understanding-the-inputs" class="anchor"></a>Understanding the inputs</h1>
<div id="the-input-data" class="section level2">
<h2 class="hasAnchor">
<a href="#the-input-data" class="anchor"></a>The input data</h2>
<p>The input data to <code><a href="../reference/run_ml.html">run_ml()</a></code> is a dataframe where each row is a sample or observation. One column (assumed to be the first) is the outcome of interest, and all of the other columns are the features. We package <code>otu_mini_bin</code> as a small example dataset with <code>mikropml</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#install.packages("devtools")</span>
<span class="co">#devtools::install_github("SchlossLab/mikropml")</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.schlosslab.org/mikropml/">mikropml</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">otu_mini_bin</span><span class="op">)</span>
<span class="co">#&gt;       dx Otu00001 Otu00002 Otu00003 Otu00004 Otu00005 Otu00006 Otu00007</span>
<span class="co">#&gt; 1 normal      350      268      213        1      208      230       70</span>
<span class="co">#&gt; 2 normal      568     1320       13      293      671      103       48</span>
<span class="co">#&gt; 3 normal      151      756      802      556      145      271       57</span>
<span class="co">#&gt; 4 normal      299       30     1018        0       25       99       75</span>
<span class="co">#&gt; 5 normal     1409      174        0        3        2     1136      296</span>
<span class="co">#&gt; 6 normal      167      712      213        4      332      534      139</span>
<span class="co">#&gt;   Otu00008 Otu00009 Otu00010</span>
<span class="co">#&gt; 1      230      235       64</span>
<span class="co">#&gt; 2      204      119      115</span>
<span class="co">#&gt; 3      176       37      710</span>
<span class="co">#&gt; 4       78      255      197</span>
<span class="co">#&gt; 5        1      537      533</span>
<span class="co">#&gt; 6      251      155      122</span></code></pre></div>
<p>Here, <code>dx</code> is the outcome column (normal or cancer), and there are 10 features (<code>Otu00001</code> through <code>Otu00010</code>). Because there are only 2 outcomes, we will be performing binary classification in the majority of the examples below. At the bottom, we will also briefly provide examples of multi-class and continuous outcomes. As you’ll see, you run them in the same way as for binary classification!</p>
<p>The feature columns are the amount of each <a href="https://en.wikipedia.org/wiki/Operational_taxonomic_unit">Operational Taxonomic Unit (OTU)</a> in microbiome samples from patients with cancer and without cancer. The goal is to predict <code>dx</code>, which stands for diagnosis. This diagnosis can be cancer or not based on an individual’s microbiome. No need to understand exactly what that means, but if you’re interested you can read more about it from the original paper <span class="citation">(Topçuoğlu et al. 2020)</span>.</p>
<p>For real machine learning applications you’ll need to use more features, but for the purposes of this vignette we’ll stick with this example dataset so everything runs faster.</p>
</div>
<div id="the-methods-we-support" class="section level2">
<h2 class="hasAnchor">
<a href="#the-methods-we-support" class="anchor"></a>The methods we support</h2>
<p>All of the methods we use are supported by a great ML wrapper package <a href="https://topepo.github.io/caret/"><code>caret</code></a>, which we use to train our machine learning models.</p>
<p>The methods we have tested (and their backend packages) are:</p>
<ul>
<li>Logistic/multiclass/linear regression (<code>"glmnet"</code>)</li>
<li>Random forest (<code>"rf"</code>)</li>
<li>Decision tree (<code>"rpart2"</code>)</li>
<li>Support vector machine with a linear basis kernel (<code>"svmRadial"</code>)</li>
<li>xgboost (<code>"xgbTree"</code>)</li>
</ul>
<p>For documentation on these methods, as well as many others, you can look at the <a href="https://topepo.github.io/caret/available-models.html">available models</a> (or see <a href="https://topepo.github.io/caret/train-models-by-tag.html">here</a> for a list by tag). While we have not vetted the other models used by <code>caret</code>, our function is general enough that others might work. While we can’t promise that we can help with other models, feel free to <a href="https://github.com/SchlossLab/mikropml/issues">open an issue on GitHub</a> if you have questions about other models and we <em>might</em> be able to help.</p>
<p>We will first focus on <code>glmnet</code>, which is our default implementation of L2-regularized logistic regression. Then we will cover a few other examples towards the end.</p>
</div>
</div>
<div id="before-running-ml" class="section level1">
<h1 class="hasAnchor">
<a href="#before-running-ml" class="anchor"></a>Before running ML</h1>
<p>Before you execute <code><a href="../reference/run_ml.html">run_ml()</a></code>, you should consider preprocessing your data, either on your own or with the <code><a href="../reference/preprocess_data.html">preprocess_data()</a></code> function. You can learn more about this in the preprocessing vignette: <code><a href="../articles/preprocess.html">vignette("preprocess")</a></code>.</p>
</div>
<div id="the-simplest-way-to-run_ml" class="section level1">
<h1 class="hasAnchor">
<a href="#the-simplest-way-to-run_ml" class="anchor"></a>The simplest way to <code>run_ml()</code>
</h1>
<p>As mentioned above, the minimal input is your dataset (<code>dataset</code>) and the machine learning model you want to use (<code>method</code>).</p>
<p>You may also want to provide:</p>
<ul>
<li>The outcome column name. By default <code><a href="../reference/run_ml.html">run_ml()</a></code> will pick the first column, but it’s best practice to specify the column name explicitly.</li>
<li>A seed so that the results will be reproducible, and so that you get the same results as those you see here (i.e have the same train/test split).</li>
</ul>
<p>Say we want to use logistic regression, then the method we will use is <code>glmnet</code>. To do so, run ML pipeline with:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_ml.html">run_ml</a></span><span class="op">(</span><span class="va">otu_mini_bin</span>,
                  <span class="st">'glmnet'</span>,
                  outcome_colname <span class="op">=</span> <span class="st">'dx'</span>,
                  seed <span class="op">=</span> <span class="fl">2019</span><span class="op">)</span></code></pre></div>
<p>You’ll notice a few things:</p>
<ol style="list-style-type: decimal">
<li>It takes a little while to run. This is because of some of the parameters we use.</li>
<li>There is a message stating that ‘dx’ is being used as the outcome column. This is what we want, but it’s a nice sanity check!</li>
<li>There was a warning. Don’t worry about this warning right now - it just means that some of the hyperparameters aren’t a good fit - but if you’re interested in learning more, see <code><a href="../articles/tuning.html">vignette("tuning")</a></code>.</li>
</ol>
<p>Now, let’s dig into the output a bit. The results is a list of 4 things:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span>
<span class="co">#&gt; [1] "trained_model"      "test_data"          "performance"       </span>
<span class="co">#&gt; [4] "feature_importance"</span></code></pre></div>
<p><code>trained_model</code> is the trained model from <code>caret</code>. There is a bunch of info in this that we won’t get into, because you can learn more from the <code><a href="https://rdrr.io/pkg/caret/man/train.html">caret::train()</a></code> documentation.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">trained_model</span><span class="op">)</span>
<span class="co">#&gt;  [1] "method"       "modelInfo"    "modelType"    "results"      "pred"        </span>
<span class="co">#&gt;  [6] "bestTune"     "call"         "dots"         "metric"       "control"     </span>
<span class="co">#&gt; [11] "finalModel"   "preProcess"   "trainingData" "resample"     "resampledCM" </span>
<span class="co">#&gt; [16] "perfNames"    "maximize"     "yLimits"      "times"        "levels"      </span>
<span class="co">#&gt; [21] "terms"        "coefnames"    "xlevels"</span></code></pre></div>
<p><code>test_data</code> is the partition of the dataset that was used for testing. In machine learning, it’s always important to have a held-out test dataset that is not used in the training stage. In this pipeline we do that using <code><a href="../reference/run_ml.html">run_ml()</a></code> where we split your data into training and testing sets. The training data are used to build the model (e.g. tune hyperparameters, learn the data) and the test data are used to evaluate how well the model performs.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">test_data</span><span class="op">)</span>
<span class="co">#&gt;        dx Otu00009 Otu00005 Otu00010 Otu00001 Otu00008 Otu00004 Otu00003</span>
<span class="co">#&gt; 9  normal      119      142      248      256      363      112      871</span>
<span class="co">#&gt; 14 normal       60      209       70       86       96        1      123</span>
<span class="co">#&gt; 16 cancer      205        5      180     1668       95       22        3</span>
<span class="co">#&gt; 17 normal      188      356      107      381     1035      915      315</span>
<span class="co">#&gt; 27 normal        4       21      161        7        1       27        8</span>
<span class="co">#&gt; 30 normal       13      166        5       31       33        5       58</span>
<span class="co">#&gt;    Otu00002 Otu00007 Otu00006</span>
<span class="co">#&gt; 9       995        0      137</span>
<span class="co">#&gt; 14      426       54       40</span>
<span class="co">#&gt; 16       20      590      570</span>
<span class="co">#&gt; 17      357      253      341</span>
<span class="co">#&gt; 27       25      322        5</span>
<span class="co">#&gt; 30      179        6       30</span></code></pre></div>
<p><code>performance</code> is a dataframe of (mainly) performance metrics (1 column for cross-validation performance metric, several for test performance metrics, and 2 columns at the end with ML method and seed):</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results</span><span class="op">$</span><span class="va">performance</span>
<span class="co">#&gt; # A tibble: 1 x 17</span>
<span class="co">#&gt;   cv_metric_AUC logLoss   AUC prAUC Accuracy Kappa    F1 Sensitivity Specificity</span>
<span class="co">#&gt;           &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;</span>
<span class="co">#&gt; 1         0.622   0.684 0.647 0.606    0.590 0.179   0.6         0.6       0.579</span>
<span class="co">#&gt; # … with 8 more variables: Pos_Pred_Value &lt;dbl&gt;, Neg_Pred_Value &lt;dbl&gt;,</span>
<span class="co">#&gt; #   Precision &lt;dbl&gt;, Recall &lt;dbl&gt;, Detection_Rate &lt;dbl&gt;,</span>
<span class="co">#&gt; #   Balanced_Accuracy &lt;dbl&gt;, method &lt;chr&gt;, seed &lt;dbl&gt;</span></code></pre></div>
<p>When using logistic regression for binary classification, area under the receiver-operator characteristic curve (AUC) is a useful metric to evaluate model performance. Because of that, it’s the default that we use for <code>mikropml</code>. However, it is crucial to evaluate your model performance using multiple metrics. Below you can find more information about other performance metrics and how to use them in our package.</p>
<p><code>cv_metric_AUC</code> is the AUC for the cross-valdation folds for the training data. This gives us a sense of how well the model performs on the training data.</p>
<p>Most of the other columns are performance metrics for the test data — the data that wasn’t used to build the model. Here, you can see that the AUC for the test data is not much above 0.5, suggesting that this model does not predict much better than chance, and that the model is overfit because the cross-valdation AUC (<code>cv_metric_AUC</code>, measured during training) is much higher than the testing AUC. This isn’t too surprising since we’re using so few features with this example dataset, so don’t be discouraged. The default option also provides a number of other performance metrics that you might be interested in, including area under the precision-recall curve (prAUC).</p>
<p>The last columns of <code>results$performance</code> are the method and seed (if you set one) to help with combining results from multiple runs (see <code><a href="../articles/parallel.html">vignette("parallel")</a></code>).</p>
<p><code>feature_importance</code> has information about feature importance values if <code>find_feature_importance = TRUE</code> (the default is <code>FALSE</code>). Since we used the defaults, there’s nothing here:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results</span><span class="op">$</span><span class="va">feature_importance</span>
<span class="co">#&gt; [1] "Skipped feature importance"</span></code></pre></div>
</div>
<div id="customizing-parameters" class="section level1">
<h1 class="hasAnchor">
<a href="#customizing-parameters" class="anchor"></a>Customizing parameters</h1>
<p>There are a few arguments that allow you to change how you execute <code><a href="../reference/run_ml.html">run_ml()</a></code>. We’ve chosen reasonable defaults for you, but we encourage you to change these if you think something else would be better for your data.</p>
<div id="changing-kfold-cv_times-and-training_frac" class="section level2">
<h2 class="hasAnchor">
<a href="#changing-kfold-cv_times-and-training_frac" class="anchor"></a>Changing <code>kfold</code>, <code>cv_times</code>, and <code>training_frac</code>
</h2>
<ul>
<li>
<code>kfold</code>: The number of folds to run for cross-valdaton (default: 5).</li>
<li>
<code>cv_times</code>: The number of times to run repeated cross-valdaton (default: 100).</li>
<li>
<code>training_frac</code>: The fraction of data for the training set (default: 0.8). The rest of the data is used for testing.</li>
</ul>
<p>Here’s an example where we change some of the default parameters:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_custom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_ml.html">run_ml</a></span><span class="op">(</span><span class="va">otu_mini_bin</span>,
                         <span class="st">'glmnet'</span>,
                         kfold <span class="op">=</span> <span class="fl">2</span>,
                         cv_times <span class="op">=</span> <span class="fl">5</span>,
                         training_frac <span class="op">=</span> <span class="fl">0.5</span>,
                         seed <span class="op">=</span> <span class="fl">2019</span><span class="op">)</span>
<span class="co">#&gt; Using 'dx' as the outcome column.</span>
<span class="co">#&gt; Loading required package: lattice</span>
<span class="co">#&gt; Loading required package: ggplot2</span>
<span class="co">#&gt; Warning in (function (w) : `caret::train()` issued the following warning:</span>
<span class="co">#&gt;  </span>
<span class="co">#&gt; simpleWarning in nominalTrainWorkflow(x = x, y = y, wts = weights, info = trainInfo, : There were missing values in resampled performance measures.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; This warning usually means that the model didn't converge in some cross-validation folds because it is predicting something close to a constant. As a result, certain performance metrics can't be calculated. This suggests that some of the hyperparameters chosen are doing very poorly.</span></code></pre></div>
<p>You might have noticed that this one ran faster — that’s because we reduced <code>kfold</code> and <code>cv_times</code>. This is okay for testing things out and may even be necessary for smaller datasets. But in general it may be better to have larger numbers for these parameters; we think the defaults are a good starting point <span class="citation">(Topçuoğlu et al. 2020)</span>.</p>
</div>
<div id="changing-the-performance-metric" class="section level2">
<h2 class="hasAnchor">
<a href="#changing-the-performance-metric" class="anchor"></a>Changing the performance metric</h2>
<p>There are two arguments that allow you to change what performance metric to use for model evaluation, and what performance metrics to calculate using the test data.</p>
<p><code>perf_metric_function</code> is the function used to calculate the performance metrics.</p>
<p>The default for classification is <code><a href="https://rdrr.io/pkg/caret/man/postResample.html">caret::multiClassSummary()</a></code> and the default for regression is <code><a href="https://rdrr.io/pkg/caret/man/postResample.html">caret::defaultSummary()</a></code>. We’d suggest not changing this unless you really know what you’re doing.</p>
<p><code>perf_metric_name</code> is the column name from the output of <code>perf_metric_function</code>. We chose reasonable defaults (AUC for binary, logLoss for multiclass, and RMSE for continuous), but the default functions calculate a bunch of different performance metrics, so you can choose a different one if you’d like.</p>
<p>The default performance metrics available for classification are:</p>
<pre><code>#&gt;  [1] "logLoss"                "AUC"                    "prAUC"                 
#&gt;  [4] "Accuracy"               "Kappa"                  "Mean_F1"               
#&gt;  [7] "Mean_Sensitivity"       "Mean_Specificity"       "Mean_Pos_Pred_Value"   
#&gt; [10] "Mean_Neg_Pred_Value"    "Mean_Precision"         "Mean_Recall"           
#&gt; [13] "Mean_Detection_Rate"    "Mean_Balanced_Accuracy"</code></pre>
<p>The default performance metrics available for regression are:</p>
<pre><code>#&gt; [1] "RMSE"     "Rsquared" "MAE"</code></pre>
<p>Here’s an example using prAUC instead of AUC:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_pr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_ml.html">run_ml</a></span><span class="op">(</span><span class="va">otu_mini_bin</span>, 
                     <span class="st">'glmnet'</span>, 
                     cv_times <span class="op">=</span> <span class="fl">5</span>, 
                     perf_metric_name <span class="op">=</span> <span class="st">'prAUC'</span>, 
                     seed <span class="op">=</span> <span class="fl">2019</span><span class="op">)</span>
<span class="co">#&gt; Using 'dx' as the outcome column.</span>
<span class="co">#&gt; Warning in (function (w) : `caret::train()` issued the following warning:</span>
<span class="co">#&gt;  </span>
<span class="co">#&gt; simpleWarning in nominalTrainWorkflow(x = x, y = y, wts = weights, info = trainInfo, : There were missing values in resampled performance measures.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; This warning usually means that the model didn't converge in some cross-validation folds because it is predicting something close to a constant. As a result, certain performance metrics can't be calculated. This suggests that some of the hyperparameters chosen are doing very poorly.</span></code></pre></div>
<p>You’ll see that the cross-valdaton metric is prAUC, instead of the default AUC:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_pr</span><span class="op">$</span><span class="va">performance</span>
<span class="co">#&gt; # A tibble: 1 x 17</span>
<span class="co">#&gt;   cv_metric_prAUC logLoss   AUC prAUC Accuracy  Kappa    F1 Sensitivity</span>
<span class="co">#&gt;             &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;       &lt;dbl&gt;</span>
<span class="co">#&gt; 1           0.577   0.691 0.663 0.605    0.538 0.0539 0.690           1</span>
<span class="co">#&gt; # … with 9 more variables: Specificity &lt;dbl&gt;, Pos_Pred_Value &lt;dbl&gt;,</span>
<span class="co">#&gt; #   Neg_Pred_Value &lt;dbl&gt;, Precision &lt;dbl&gt;, Recall &lt;dbl&gt;, Detection_Rate &lt;dbl&gt;,</span>
<span class="co">#&gt; #   Balanced_Accuracy &lt;dbl&gt;, method &lt;chr&gt;, seed &lt;dbl&gt;</span></code></pre></div>
</div>
<div id="using-groups" class="section level2">
<h2 class="hasAnchor">
<a href="#using-groups" class="anchor"></a>Using groups</h2>
<p>The optional <code>groups</code> is a vector of groups to keep together when splitting the data into train and test sets and for cross-validation. This can be a little finicky depending on how many samples and groups you have, but sometimes it’s important to split up the data based on a grouping instead of just randomly. This allows you to control for similarities within groups that you don’t want to skew your predictions (i.e. batch effects). For example, with biological data you may have samples collected from multiple hospitals, and you might like to keep observations from the same hospital in the same split.</p>
<p>Here’s an example where we split the data into train/test sets based on a group:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># make random groups</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2019</span><span class="op">)</span>
<span class="va">grps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">otu_mini_bin</span><span class="op">)</span>,replace<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="va">results_grp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_ml.html">run_ml</a></span><span class="op">(</span><span class="va">otu_mini_bin</span>, 
                      <span class="st">'glmnet'</span>, 
                      cv_times <span class="op">=</span> <span class="fl">5</span>, 
                      training_frac <span class="op">=</span> <span class="fl">0.8</span>, 
                      groups <span class="op">=</span> <span class="va">grps</span>, 
                      seed <span class="op">=</span> <span class="fl">2019</span><span class="op">)</span></code></pre></div>
<p>The one difference here is <code><a href="../reference/run_ml.html">run_ml()</a></code> will report how much of the data is in the training set if you run the above code chunk. This is because it won’t be exactly what you specify with <code>training_frac</code>, since you have to include all of one group in either the training set <em>or</em> the test set.</p>
</div>
</div>
<div id="finding-feature-importance" class="section level1">
<h1 class="hasAnchor">
<a href="#finding-feature-importance" class="anchor"></a>Finding feature importance</h1>
<p>To find which features are contributing to predictive power, you can use <code>find_feature_importance = TRUE</code>. How we use permutation importance to determine feature importance is decribed in <span class="citation">(Topçuoğlu et al. 2020)</span>. Briefly, it permutes each of the features individually (or correlated ones together) and evaluates how much the performance metric decreases. The more performance decreases when the feature is randomly shuffled, the more important that feature is. The default is <code>FALSE</code> because it takes a while to run and is only useful if you want to know what features are important in predicting your outcome.</p>
<p>Let’s look at some feature importance results:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_imp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_ml.html">run_ml</a></span><span class="op">(</span><span class="va">otu_mini_bin</span>,
  <span class="st">"rf"</span>,
  outcome_colname <span class="op">=</span> <span class="st">"dx"</span>,
  find_feature_importance <span class="op">=</span> <span class="cn">TRUE</span>,
  seed <span class="op">=</span> <span class="fl">2019</span>
<span class="op">)</span></code></pre></div>
<p>Now, we can check out the feature importances:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_imp</span><span class="op">$</span><span class="va">feature_importance</span>
<span class="co">#&gt;    perf_metric perf_metric_diff    names method perf_metric_name seed</span>
<span class="co">#&gt; 1    0.5411250        0.0213750 Otu00009     rf              AUC 2019</span>
<span class="co">#&gt; 2    0.5179625        0.0445375 Otu00005     rf              AUC 2019</span>
<span class="co">#&gt; 3    0.4996375        0.0628625 Otu00010     rf              AUC 2019</span>
<span class="co">#&gt; 4    0.5520625        0.0104375 Otu00001     rf              AUC 2019</span>
<span class="co">#&gt; 5    0.5322750        0.0302250 Otu00008     rf              AUC 2019</span>
<span class="co">#&gt; 6    0.6352875       -0.0727875 Otu00004     rf              AUC 2019</span>
<span class="co">#&gt; 7    0.5527375        0.0097625 Otu00003     rf              AUC 2019</span>
<span class="co">#&gt; 8    0.5723000       -0.0098000 Otu00002     rf              AUC 2019</span>
<span class="co">#&gt; 9    0.5423500        0.0201500 Otu00007     rf              AUC 2019</span>
<span class="co">#&gt; 10   0.5448000        0.0177000 Otu00006     rf              AUC 2019</span></code></pre></div>
<p>There are several columns:</p>
<ol style="list-style-type: decimal">
<li>
<code>perf_metric</code>: The performance value of the permuted feature.</li>
<li>
<code>perf_metric_diff</code>: The difference between the performance for the true and permuted data (i.e. test performance minus permuted performance). Features with a larger <code>perf_metric_diff</code> are more important.</li>
<li>
<code>names</code>: The feature that was permuted.</li>
<li>
<code>method</code>: The ML method used.</li>
<li>
<code>perf_metric_name</code>: The peformance metric used.</li>
<li>
<code>seed</code>: The seed (if set).</li>
</ol>
<p>As you can see here, the differences are negligible (close to zero), which makes sense since our model isn’t great. If you’re interested in feature importance, it’s especially useful to run multiple different train/test splits, as shown in our <a href="https://github.com/SchlossLab/mikropml-snakemake-workflow/">example snakemake workflow</a>.</p>
<p>You can also choose to permute correlated features together using <code>corr_thresh</code> (default: 1). Any features that are above the correlation threshold are permuted together; i.e. perfectly correlated features are permuted together when using the default value.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_imp_corr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_ml.html">run_ml</a></span><span class="op">(</span><span class="va">otu_mini_bin</span>,
                           <span class="st">'glmnet'</span>,
                           cv_times <span class="op">=</span> <span class="fl">5</span>,
                           find_feature_importance <span class="op">=</span> <span class="cn">TRUE</span>,
                           corr_thresh <span class="op">=</span> <span class="fl">0.2</span>,
                           seed <span class="op">=</span> <span class="fl">2019</span><span class="op">)</span>
<span class="co">#&gt; Using 'dx' as the outcome column.</span>
<span class="co">#&gt; Warning in (function (w) : `caret::train()` issued the following warning:</span>
<span class="co">#&gt;  </span>
<span class="co">#&gt; simpleWarning in nominalTrainWorkflow(x = x, y = y, wts = weights, info = trainInfo, : There were missing values in resampled performance measures.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; This warning usually means that the model didn't converge in some cross-validation folds because it is predicting something close to a constant. As a result, certain performance metrics can't be calculated. This suggests that some of the hyperparameters chosen are doing very poorly.</span>
<span class="va">results_imp_corr</span><span class="op">$</span><span class="va">feature_importance</span>
<span class="co">#&gt;   perf_metric perf_metric_diff</span>
<span class="co">#&gt; 1   0.5992368       0.04813158</span>
<span class="co">#&gt; 2   0.6369474       0.01042105</span>
<span class="co">#&gt; 3   0.5431579       0.10421053</span>
<span class="co">#&gt;                                                                     names</span>
<span class="co">#&gt; 1                                                                Otu00008</span>
<span class="co">#&gt; 2                                                                Otu00004</span>
<span class="co">#&gt; 3 Otu00010|Otu00009|Otu00001|Otu00007|Otu00006|Otu00003|Otu00002|Otu00005</span>
<span class="co">#&gt;   method perf_metric_name seed</span>
<span class="co">#&gt; 1 glmnet              AUC 2019</span>
<span class="co">#&gt; 2 glmnet              AUC 2019</span>
<span class="co">#&gt; 3 glmnet              AUC 2019</span></code></pre></div>
<p>You can see which features were permuted together in the <code>names</code> column. Here all 3 features were permuted together (which doesn’t really make sense, but it’s just an example).</p>
<p>If you previously executed <code><a href="../reference/run_ml.html">run_ml()</a></code> without feature importance but now wish to find feature importance after the fact, see the example code in the <code><a href="../reference/get_feature_importance.html">get_feature_importance()</a></code> documentation.</p>
</div>
<div id="tuning-hyperparameters-using-the-hyperparameter-argument" class="section level1">
<h1 class="hasAnchor">
<a href="#tuning-hyperparameters-using-the-hyperparameter-argument" class="anchor"></a>Tuning hyperparameters (using the <code>hyperparameter</code> argument)</h1>
<p>This is important, so we have a whole vignette about them. The bottom line is we provide default hyperparameters that you can start with, but it’s important to tune your hyperparameters. For more information about what the default hyperparameters are, and how to tune hyperparameters, see <code><a href="../articles/tuning.html">vignette("tuning")</a></code>.</p>
</div>
<div id="other-models" class="section level1">
<h1 class="hasAnchor">
<a href="#other-models" class="anchor"></a>Other models</h1>
<p>Here are examples of how to train and evaluate other models. The output for all of them is very similar, so we won’t go into those details.</p>
<div id="random-forest" class="section level2">
<h2 class="hasAnchor">
<a href="#random-forest" class="anchor"></a>Random forest</h2>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_ml.html">run_ml</a></span><span class="op">(</span><span class="va">otu_mini_bin</span>,
                     <span class="st">'rf'</span>,
                     cv_times <span class="op">=</span> <span class="fl">5</span>,
                     seed <span class="op">=</span> <span class="fl">2019</span><span class="op">)</span></code></pre></div>
<p>You can also change the number of trees to use for random forest (<code>ntree</code>; default: 1000). This can’t be tuned using <code>rf</code> package implementation of random forest. Please refer to <code>caret</code> documentation if you are interested in other packages with random forest implementations.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_rf_nt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_ml.html">run_ml</a></span><span class="op">(</span><span class="va">otu_mini_bin</span>,
                        <span class="st">'rf'</span>,
                        cv_times <span class="op">=</span> <span class="fl">5</span>,
                        ntree <span class="op">=</span> <span class="fl">10</span>,
                        seed <span class="op">=</span> <span class="fl">2019</span><span class="op">)</span></code></pre></div>
</div>
<div id="decision-tree" class="section level2">
<h2 class="hasAnchor">
<a href="#decision-tree" class="anchor"></a>Decision tree</h2>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_ml.html">run_ml</a></span><span class="op">(</span><span class="va">otu_mini_bin</span>,
                     <span class="st">'rpart2'</span>,
                     cv_times <span class="op">=</span> <span class="fl">5</span>,
                     seed <span class="op">=</span> <span class="fl">2019</span><span class="op">)</span></code></pre></div>
</div>
<div id="svm" class="section level2">
<h2 class="hasAnchor">
<a href="#svm" class="anchor"></a>SVM</h2>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_svm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_ml.html">run_ml</a></span><span class="op">(</span><span class="va">otu_mini_bin</span>,
                      <span class="st">'svmRadial'</span>,
                      cv_times <span class="op">=</span> <span class="fl">5</span>,
                      seed <span class="op">=</span> <span class="fl">2019</span><span class="op">)</span></code></pre></div>
<p>If you get a message “maximum number of iterations reached”, see <a href="https://github.com/topepo/caret/issues/425">this issue</a> in caret.</p>
</div>
</div>
<div id="other-data" class="section level1">
<h1 class="hasAnchor">
<a href="#other-data" class="anchor"></a>Other data</h1>
<div id="multiclass-data" class="section level2">
<h2 class="hasAnchor">
<a href="#multiclass-data" class="anchor"></a>Multiclass data</h2>
<p>We provide <code>otu_mini_multi</code> with a multiclass outcome (three or more outcomes):</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">otu_mini_multi</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="st">'dx'</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] "adenoma"   "carcinoma" "normal"</span></code></pre></div>
<p>Here’s an example of running multiclass data:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_multi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_ml.html">run_ml</a></span><span class="op">(</span><span class="va">otu_mini_multi</span>,
                        outcome_colname <span class="op">=</span> <span class="st">"dx"</span>,
                        seed <span class="op">=</span> <span class="fl">2019</span>
<span class="op">)</span></code></pre></div>
<p>The performance metrics are slightly different, but the format of everything else is the same:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_multi</span><span class="op">$</span><span class="va">performance</span>
<span class="co">#&gt; # A tibble: 1 x 17</span>
<span class="co">#&gt;   cv_metric_logLoss logLoss   AUC prAUC Accuracy  Kappa Mean_F1 Mean_Sensitivity</span>
<span class="co">#&gt;               &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;              &lt;dbl&gt;</span>
<span class="co">#&gt; 1              1.07    1.11 0.506 0.353    0.382 0.0449 &lt;NA&gt;               0.360</span>
<span class="co">#&gt; # … with 9 more variables: Mean_Specificity &lt;dbl&gt;, Mean_Pos_Pred_Value &lt;chr&gt;,</span>
<span class="co">#&gt; #   Mean_Neg_Pred_Value &lt;dbl&gt;, Mean_Precision &lt;chr&gt;, Mean_Recall &lt;dbl&gt;,</span>
<span class="co">#&gt; #   Mean_Detection_Rate &lt;dbl&gt;, Mean_Balanced_Accuracy &lt;dbl&gt;, method &lt;chr&gt;,</span>
<span class="co">#&gt; #   seed &lt;dbl&gt;</span></code></pre></div>
</div>
<div id="continuous-data" class="section level2">
<h2 class="hasAnchor">
<a href="#continuous-data" class="anchor"></a>Continuous data</h2>
<p>And here’s an example for running continuous data, where the outcome column is numerical:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_cont</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_ml.html">run_ml</a></span><span class="op">(</span><span class="va">otu_mini_bin</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">11</span><span class="op">]</span>,
                       <span class="st">'glmnet'</span>,
                       outcome_colname <span class="op">=</span> <span class="st">'Otu00001'</span>,
                       seed <span class="op">=</span> <span class="fl">2019</span><span class="op">)</span></code></pre></div>
<p>Again, the performance metrics are slightly different, but the format of the rest is the same:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_cont</span><span class="op">$</span><span class="va">performance</span>
<span class="co">#&gt; # A tibble: 1 x 6</span>
<span class="co">#&gt;   cv_metric_RMSE  RMSE Rsquared   MAE method  seed</span>
<span class="co">#&gt;            &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1           622.  731.   0.0893  472. glmnet  2019</span></code></pre></div>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-tang_democratizing_2020">
<p>Tang, Shengpu, Parmida Davarmanesh, Yanmeng Song, Danai Koutra, Michael W. Sjoding, and Jenna Wiens. 2020. “Democratizing EHR Analyses with FIDDLE: A Flexible Data-Driven Preprocessing Pipeline for Structured Clinical Data.” <em>J Am Med Inform Assoc</em>, October. <a href="https://doi.org/10.1093/jamia/ocaa139">https://doi.org/10.1093/jamia/ocaa139</a>.</p>
</div>
<div id="ref-topcuoglu_framework_2020">
<p>Topçuoğlu, Begüm D., Nicholas A. Lesniak, Mack T. Ruffin, Jenna Wiens, and Patrick D. Schloss. 2020. “A Framework for Effective Application of Machine Learning to Microbiome-Based Classification Problems.” <em>mBio</em> 11 (3). <a href="https://doi.org/10.1128/mBio.00434-20">https://doi.org/10.1128/mBio.00434-20</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://github.com/BTopcuoglu">Begüm Topçuoğlu</a>, <a href="https://github.com/zenalapp">Zena Lapp</a>, <a href="https://github.com/kelly-sovacool">Kelly Sovacool</a>, Evan Snitkin, Jenna Wiens, <a href="https://github.com/pschloss">Patrick Schloss</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
